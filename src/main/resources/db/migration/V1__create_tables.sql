-- V1__create_tables.sql
-- Script de criação das tabelas do sistema ESG - Eficiência Energética

-- Tabela de Usuários
CREATE TABLE USUARIO (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    USERNAME VARCHAR2(50) NOT NULL UNIQUE,
    PASSWORD VARCHAR2(100) NOT NULL,
    NOME VARCHAR2(100) NOT NULL,
    EMAIL VARCHAR2(100) NOT NULL UNIQUE,
    ROLE VARCHAR2(20) NOT NULL CHECK (ROLE IN ('ROLE_ADMIN', 'ROLE_USER')),
    ATIVO NUMBER(1) DEFAULT 1 NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);

-- Tabela de Unidades
CREATE TABLE UNIDADE (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    NOME VARCHAR2(100) NOT NULL,
    LOCALIZACAO VARCHAR2(255) NOT NULL,
    LIMITE_CONSUMO_DIARIO_KWH NUMBER(10,2) NOT NULL,
    ATIVO NUMBER(1) DEFAULT 1 NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL
);

-- Tabela de Leituras de Consumo
CREATE TABLE LEITURA (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    UNIDADE_ID NUMBER NOT NULL,
    TIMESTAMP TIMESTAMP NOT NULL,
    CONSUMO_KWH NUMBER(10,2) NOT NULL,
    SENSOR_ID VARCHAR2(50),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT FK_LEITURA_UNIDADE FOREIGN KEY (UNIDADE_ID) REFERENCES UNIDADE(ID)
);

-- Tabela de Alertas
CREATE TABLE ALERTA (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    UNIDADE_ID NUMBER NOT NULL,
    TIPO VARCHAR2(50) NOT NULL,
    MENSAGEM VARCHAR2(500) NOT NULL,
    CONSUMO_REGISTRADO_KWH NUMBER(10,2) NOT NULL,
    LIMITE_KWH NUMBER(10,2) NOT NULL,
    LIDO NUMBER(1) DEFAULT 0 NOT NULL,
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT FK_ALERTA_UNIDADE FOREIGN KEY (UNIDADE_ID) REFERENCES UNIDADE(ID)
);

-- Tabela de Agendamentos
CREATE TABLE AGENDAMENTO (
    ID NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    UNIDADE_ID NUMBER NOT NULL,
    DESCRICAO VARCHAR2(255) NOT NULL,
    TIPO_ACAO VARCHAR2(50) NOT NULL,
    DATA_HORA_AGENDADA TIMESTAMP NOT NULL,
    STATUS VARCHAR2(20) NOT NULL CHECK (STATUS IN ('PENDENTE', 'EXECUTADO', 'CANCELADO')),
    OBSERVACAO VARCHAR2(500),
    CREATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    UPDATED_AT TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
    CONSTRAINT FK_AGENDAMENTO_UNIDADE FOREIGN KEY (UNIDADE_ID) REFERENCES UNIDADE(ID)
);

-- Índices para melhorar performance
CREATE INDEX IDX_LEITURA_UNIDADE ON LEITURA(UNIDADE_ID);
CREATE INDEX IDX_LEITURA_TIMESTAMP ON LEITURA(TIMESTAMP);
CREATE INDEX IDX_ALERTA_UNIDADE ON ALERTA(UNIDADE_ID);
CREATE INDEX IDX_ALERTA_LIDO ON ALERTA(LIDO);
CREATE INDEX IDX_AGENDAMENTO_UNIDADE ON AGENDAMENTO(UNIDADE_ID);
CREATE INDEX IDX_AGENDAMENTO_STATUS ON AGENDAMENTO(STATUS);
CREATE INDEX IDX_AGENDAMENTO_DATA ON AGENDAMENTO(DATA_HORA_AGENDADA);

COMMIT;
